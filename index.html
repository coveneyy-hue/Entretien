<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entretien</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #f6f7f9; color: #111; }
    header { padding: 14px 16px; background: #fff; position: sticky; top: 0; border-bottom: 1px solid #e6e8ee; z-index: 3; }
    h1 { margin: 0; font-size: 18px; }
    main { padding: 12px; max-width: 980px; margin: 0 auto; padding-bottom: 120px; }

    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
    button { border: 1px solid #d7dbe6; background: #fff; border-radius: 10px; padding: 10px 12px; font-weight: 800; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button.danger { border-color: #ffced0; }
    button:active { transform: scale(0.99); }
    button[disabled]{ opacity:.55; }

    .pill { font-size: 12px; border: 1px solid #e6e8ee; border-radius: 999px; padding: 6px 10px; background: #fff; }

    .list { display: grid; gap: 10px; margin-top: 12px; }
    .row {
      display: grid;
      grid-template-columns: 38px 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      border: 1px solid #eef0f6;
      border-radius: 12px;
      background: #fff;
    }
    .row.selected { outline: 2px solid #111; }

    .desc { font-weight: 900; user-select: text; -webkit-user-select: text; cursor: default; line-height: 1.1; }

    .meta { margin-top: 6px; display: grid; gap: 4px; }
    .meta-line { display:flex; gap: 10px; flex-wrap: wrap; align-items: baseline; font-size: 12px; color: #333; }
    .k { color: #555; font-weight: 800; }
    .v { font-weight: 950; }

    .status { font-size: 12px; font-weight: 900; padding: 6px 8px; border-radius: 999px; border: 1px solid #eee; white-space: nowrap; }
    .due { color: #b00020; border-color: #ffd3da; background: #fff5f6; }
    .ok { color: #116b2f; border-color: #cfe9d8; background: #f3fbf6; }

    .actions { display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap; align-items: center; }
    .chk-wrap { display: flex; justify-content: center; }
    input[type="checkbox"] { width: 22px; height: 22px; }

    /* Top due banner */
    .due-banner {
      background: #fff5f6;
      border: 1px solid #ffd3da;
      color: #b00020;
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .due-banner .t { font-weight: 1000; }
    .due-banner ul { margin: 8px 0 0 18px; padding: 0; }
    .due-banner li { margin: 4px 0; }
    .small { font-size: 12px; opacity: .9; }

    /* Bottom fixed bar */
    .bottom-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      border-top: 1px solid #e6e8ee;
      padding: 10px 12px;
      z-index: 4;
    }
    .bottom-inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .bottom-actions { display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end; }

    dialog { width: min(560px, 94vw); border: 1px solid #e6e8ee; border-radius: 14px; padding: 0; }
    dialog::backdrop { background: rgba(0,0,0,.35); }
    .modal-head { padding: 12px 14px; border-bottom: 1px solid #eef0f6; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 12px 14px; }
    .modal-foot { padding: 12px 14px; border-top: 1px solid #eef0f6; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
    .count { float: right; font-size: 12px; color: #666; }
    .tabs { display: flex; gap: 8px; margin-top: 10px; }
    .tabs button { flex: 1; }
    .hidden { display: none; }
    .hist-item { padding: 10px; border: 1px solid #eef0f6; border-radius: 12px; background: #fff; }
    .hist-item .t { font-weight: 900; }
    .hist-item .s { font-size: 12px; color: #555; margin-top: 2px; }

    input[type="text"], input[type="number"], input[type="date"], select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d7dbe6;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }
    input[disabled] { background: #f3f4f7; color: #333; }
    label { font-size: 12px; color: #333; font-weight: 900; display: block; margin: 10px 0 6px; }
  </style>
</head>
<body>
<header>
  <h1>Entretien</h1>
  <div class="toolbar">
    <button class="primary" id="btnAdd">+ Ajouter</button>
    <button id="btnHistory">Journal</button>
    <span class="pill" id="stats">‚Äî</span>
  </div>
</header>

<main>
  <div id="dueBanner" class="due-banner hidden" role="alert"></div>
  <div class="list" id="list"></div>
</main>

<!-- Bottom fixed bar -->
<div class="bottom-bar">
  <div class="bottom-inner">
    <div class="pill" id="pendingInfo">0 s√©lectionn√©(s) √† enregistrer</div>
    <div class="bottom-actions">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport">Import JSON</button>
      <button id="btnClearChecks">R√©initialiser checks</button>
      <button class="primary" id="btnSaveChecks" disabled>Enregistrer</button>
    </div>
  </div>
  <input id="fileInput" type="file" accept="application/json,.json" class="hidden" />
</div>

<!-- Modal Ajout/Modification -->
<dialog id="dlgEdit">
  <div class="modal-head">
    <strong id="dlgTitle">Ajouter</strong>
    <button id="btnCloseEdit" aria-label="Fermer">‚úï</button>
  </div>
  <div class="modal-body">
    <label>
      Description <span class="count" id="descCount">0/50</span>
      <input id="fDesc" maxlength="50" placeholder="Ex: Changer filtre fournaise" />
    </label>

    <label>
      Nombre d‚Äôit√©rations (Fait)
      <input id="fIter" type="number" disabled value="0" />
    </label>

    <label>Date de d√©but
      <input id="fStart" type="date" />
    </label>

    <label>Intervalle (jours)
      <input id="fInt" type="number" min="1" step="1" placeholder="Ex: 90" />
    </label>
  </div>
  <div class="modal-foot">
    <button id="btnDelete" class="danger hidden">Supprimer</button>
    <button id="btnCancel">Annuler</button>
    <button id="btnSave" class="primary">Enregistrer l‚Äôitem</button>
  </div>
</dialog>

<!-- Modal Journal -->
<dialog id="dlgHistory">
  <div class="modal-head">
    <strong>Journal (Historique)</strong>
    <button id="btnCloseHist" aria-label="Fermer">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="tabs">
      <button id="tabGlobal" class="primary">Regroup√© global</button>
      <button id="tabByItem">Par item</button>
    </div>

    <div id="viewGlobal" style="margin-top:12px; display:grid; gap:10px;"></div>

    <div id="viewByItem" class="hidden" style="margin-top:12px;">
      <select id="histItemSelect"></select>
      <div id="histItemEvents" style="margin-top:10px; display:grid; gap:10px;"></div>
    </div>

    <div class="small" style="margin-top:12px;">
      Astuce : Export/Import JSON te permet de sauvegarder ou restaurer tes donn√©es.
    </div>
  </div>
  <div class="modal-foot">
    <button id="btnClearHist" class="danger">Vider le journal</button>
    <button id="btnCloseHist2" class="primary">OK</button>
  </div>
</dialog>

<script>
(() => {
  // ===== Utils =====
  const pad2 = n => String(n).padStart(2, "0");
  const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fromYMD = (s) => { const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d, 0,0,0,0); };
  const startOfToday = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
  const daysBetween = (a, b) => Math.floor((b.getTime() - a.getTime()) / 86400000);
  const addDays = (d, n) => new Date(d.getTime() + n * 86400000);
  const fmtDT = (ts) => new Date(ts).toLocaleString("fr-CA", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  const escapeHtml = (s) => s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));

  // ===== IndexedDB =====
  const DB_NAME = "EntretienDB";
  const DB_VER  = 1;
  let db;

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;

        const items = db.createObjectStore("items", { keyPath: "id" });
        items.createIndex("by_desc", "description", { unique: false });

        const checks = db.createObjectStore("checks", { keyPath: "id" });
        checks.createIndex("by_item", "itemId", { unique: false });
        checks.createIndex("by_ts", "dateCheck", { unique: false });

        const alerts = db.createObjectStore("alerts", { keyPath: "id" });
        alerts.createIndex("by_item", "itemId", { unique: false });
        alerts.createIndex("by_dueKey", "dueKey", { unique: false });
        alerts.createIndex("by_ts", "dateAlert", { unique: false });

        const meta = db.createObjectStore("meta", { keyPath: "key" });
        meta.put({ key: "seed", value: 1 });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  function tx(storeNames, mode="readonly") {
    const t = db.transaction(storeNames, mode);
    return { t, stores: Object.fromEntries(storeNames.map(n => [n, t.objectStore(n)])) };
  }

  async function nextId() {
    const { t, stores } = tx(["meta"], "readwrite");
    return await new Promise((resolve, reject) => {
      const get = stores.meta.get("seed");
      get.onsuccess = () => {
        const seed = get.result?.value ?? 1;
        stores.meta.put({ key: "seed", value: seed + 1 });
        t.oncomplete = () => resolve(seed);
      };
      get.onerror = () => reject(get.error);
    });
  }

  function getAll(storeName, indexName=null, query=null) {
    return new Promise((resolve, reject) => {
      const { stores } = tx([storeName], "readonly");
      const source = indexName ? stores[storeName].index(indexName) : stores[storeName];
      const req = query ? source.getAll(query) : source.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }

  function put(storeName, value) {
    return new Promise((resolve, reject) => {
      const { t, stores } = tx([storeName], "readwrite");
      stores[storeName].put(value);
      t.oncomplete = () => resolve();
      t.onerror = () => reject(t.error);
    });
  }

  async function deleteItemCascade(itemId) {
    const checks = await getAll("checks", "by_item", itemId);
    const alerts = await getAll("alerts", "by_item", itemId);

    const { t, stores } = tx(["items","checks","alerts"], "readwrite");
    stores.items.delete(itemId);
    checks.forEach(c => stores.checks.delete(c.id));
    alerts.forEach(a => stores.alerts.delete(a.id));

    return await new Promise((resolve, reject) => {
      t.oncomplete = () => resolve();
      t.onerror = () => reject(t.error);
    });
  }

  async function deleteChecksForItem(itemId) {
    const list = await getAll("checks", "by_item", itemId);
    if (!list.length) return;
    const { t, stores } = tx(["checks"], "readwrite");
    list.forEach(c => stores.checks.delete(c.id));
    return await new Promise((resolve, reject) => {
      t.oncomplete = resolve;
      t.onerror = () => reject(t.error);
    });
  }

  async function clearAllData() {
    const { t, stores } = tx(["items","checks","alerts"], "readwrite");
    stores.items.clear();
    stores.checks.clear();
    stores.alerts.clear();
    return await new Promise((resolve, reject) => {
      t.oncomplete = resolve;
      t.onerror = () => reject(t.error);
    });
  }

  // ===== Business logic =====
  async function lastCheckTs(itemId) {
    const list = await getAll("checks", "by_item", itemId);
    if (!list.length) return null;
    list.sort((a,b)=>b.dateCheck - a.dateCheck);
    return list[0].dateCheck;
  }

  async function computeStatus(item) {
    const today = startOfToday();
    const last = await lastCheckTs(item.id);
    const ref = last ? new Date(last) : fromYMD(item.dateDebut);
    ref.setHours(0,0,0,0);

    const dueDate = addDays(ref, Number(item.intervalJours));
    dueDate.setHours(0,0,0,0);

    const daysDue = Math.max(0, daysBetween(dueDate, today));
    const isDue = today.getTime() >= dueDate.getTime();
    return { lastTs: last, dueDate, isDue, daysDue };
  }

  async function ensureAlertLogged(item, status) {
    if (!status.isDue) return;
    const dueYMD = toYMD(status.dueDate);
    const dueKey = `${item.id}|${dueYMD}`;
    const all = await getAll("alerts");
    if (all.some(a => a.dueKey === dueKey)) return;

    const id = await nextId();
    await put("alerts", { id, itemId: item.id, dueKey, dueDateYMD: dueYMD, dateAlert: Date.now() });
  }

  // ===== UI refs =====
  const elList = document.querySelector("#list");
  const elStats = document.querySelector("#stats");
  const dueBanner = document.querySelector("#dueBanner");

  const pendingInfo = document.querySelector("#pendingInfo");
  const btnSaveChecks = document.querySelector("#btnSaveChecks");
  const btnClearChecks = document.querySelector("#btnClearChecks");

  const btnExport = document.querySelector("#btnExport");
  const btnImport = document.querySelector("#btnImport");
  const fileInput = document.querySelector("#fileInput");

  // Edit modal
  const dlgEdit = document.querySelector("#dlgEdit");
  const dlgTitle = document.querySelector("#dlgTitle");
  const fDesc = document.querySelector("#fDesc");
  const fIter = document.querySelector("#fIter");
  const fStart = document.querySelector("#fStart");
  const fInt = document.querySelector("#fInt");
  const descCount = document.querySelector("#descCount");
  const btnDelete = document.querySelector("#btnDelete");

  // History modal
  const dlgHistory = document.querySelector("#dlgHistory");
  const viewGlobal = document.querySelector("#viewGlobal");
  const viewByItem = document.querySelector("#viewByItem");
  const histItemSelect = document.querySelector("#histItemSelect");
  const histItemEvents = document.querySelector("#histItemEvents");
  const tabGlobal = document.querySelector("#tabGlobal");
  const tabByItem = document.querySelector("#tabByItem");

  let selectedRowIndex = -1;
  let currentRows = []; // [{item, st}]
  let editingId = null;

  // Batch selection (checkboxes)
  const pending = new Set();

  function setDescCount() { descCount.textContent = `${fDesc.value.length}/50`; }
  fDesc.addEventListener("input", setDescCount);

  function openEdit(item=null) {
    editingId = item ? item.id : null;
    dlgTitle.textContent = item ? "Modifier" : "Ajouter";
    fDesc.value = item ? item.description : "";
    fStart.value = item ? item.dateDebut : toYMD(startOfToday());
    fInt.value = item ? item.intervalJours : "30";
    setDescCount();
    btnDelete.classList.toggle("hidden", !item);

    // it√©rations (lecture seule)
    if (!item) {
      fIter.value = 0;
    } else {
      getAll("checks", "by_item", item.id).then(list => {
        fIter.value = list.length;
      });
    }

    dlgEdit.showModal();
    setTimeout(()=>fDesc.focus(), 50);
  }
  function closeEdit() { dlgEdit.close(); }

  async function saveEdit() {
    const description = fDesc.value.trim();
    if (!description) return alert("Description requise.");
    if (description.length > 50) return alert("Max 50 caract√®res.");
    const dateDebut = fStart.value;
    if (!dateDebut) return alert("Date de d√©but requise.");
    const intervalJours = Number(fInt.value);
    if (!Number.isFinite(intervalJours) || intervalJours < 1) return alert("Intervalle (jours) doit √™tre >= 1.");

    if (editingId == null) {
      const id = await nextId();
      await put("items", { id, description, dateDebut, intervalJours });
    } else {
      // Prompt de r√©initialisation si la date/intervalle change et qu'il existe des checks
      const old = (await getAll("items")).find(x => x.id === editingId);
      const dateChanged = old && old.dateDebut !== dateDebut;
      const intChanged  = old && Number(old.intervalJours) !== Number(intervalJours);

      if (dateChanged || intChanged) {
        const existingChecks = await getAll("checks", "by_item", editingId);
        if (existingChecks.length > 0) {
          const okReset = confirm(
            "Tu as modifi√© la date de d√©but et/ou l‚Äôintervalle.\n\n" +
            "Veux-tu R√âINITIALISER le compteur (supprimer l‚Äôhistorique 'Fait')\n" +
            "pour recalculer la prochaine date √† partir de la nouvelle date de d√©but ?"
          );
          if (okReset) {
            await deleteChecksForItem(editingId);
            fIter.value = 0;
          }
        }
      }

      await put("items", { id: editingId, description, dateDebut, intervalJours });
    }

    closeEdit();
    await render();
  }

  async function doDelete() {
    if (editingId == null) return;
    const ok = confirm("Supprimer cet item (et son journal) ?");
    if (!ok) return;
    await deleteItemCascade(editingId);
    pending.delete(editingId);
    closeEdit();
    await render();
  }

  function selectRow(i) {
    selectedRowIndex = i;
    [...elList.querySelectorAll(".row")].forEach((r, idx) => r.classList.toggle("selected", idx === i));
  }

  function updatePendingInfo() {
    pendingInfo.textContent = `${pending.size} s√©lectionn√©(s) √† enregistrer`;
    btnSaveChecks.disabled = pending.size === 0;
  }

  function buildConfirmationList() {
    const selected = currentRows.filter(r => pending.has(r.item.id)).map(r => r.item.description);
    selected.sort((a,b)=>a.localeCompare(b,"fr"));
    const preview = selected.slice(0, 10);
    const more = selected.length - preview.length;
    const lines = preview.map(s => `‚Ä¢ ${s}`);
    if (more > 0) lines.push(`‚Ä¢ ‚Ä¶ et ${more} autre(s)`);
    return { count: selected.length, text: lines.join("\n") };
  }

  async function savePendingChecks() {
    if (pending.size === 0) return;

    const { count, text } = buildConfirmationList();
    const ok = confirm(
      `Enregistrer "Fait" pour ${count} item(s) ?\n\n${text}\n\n` +
      `√áa r√©initialise leur prochaine date selon l‚Äôintervalle.`
    );
    if (!ok) return;

    const now = Date.now();
    for (const itemId of pending) {
      const id = await nextId();
      await put("checks", { id, itemId, dateCheck: now });
    }

    pending.clear();
    updatePendingInfo();
    await render();
  }

  function clearPendingChecksUIOnly() {
    pending.clear();
    updatePendingInfo();
    render();
  }

  function renderDueBanner(dueRows) {
    if (!dueRows.length) {
      dueBanner.classList.add("hidden");
      dueBanner.innerHTML = "";
      return;
    }

    dueRows.sort((a,b)=>a.st.dueDate - b.st.dueDate);

    const itemsHtml = dueRows.slice(0, 20).map(r => {
      const dueYMD = toYMD(r.st.dueDate);
      return `<li><strong>${escapeHtml(r.item.description)}</strong> ‚Äî d√ª le <strong>${dueYMD}</strong> (retard: ${r.st.daysDue} j)</li>`;
    }).join("");

    const more = dueRows.length - Math.min(20, dueRows.length);
    const moreHtml = more > 0 ? `<div class="small" style="margin-top:8px;">‚Ä¶ et ${more} autre(s) √©l√©ment(s) d√ª(s).</div>` : "";

    dueBanner.innerHTML = `
      <div class="t">‚ö†Ô∏è Entretien(s) d√ª(s) (${dueRows.length})</div>
      <ul>${itemsHtml}</ul>
      ${moreHtml}
    `;
    dueBanner.classList.remove("hidden");
  }

  async function render() {
    const items = await getAll("items");

    const computed = [];
    for (const it of items) {
      const st = await computeStatus(it);
      await ensureAlertLogged(it, st);
      computed.push({ item: it, st });
    }

    // DU first, then nearest dueDate
    computed.sort((a,b) => {
      if (a.st.isDue !== b.st.isDue) return a.st.isDue ? -1 : 1;
      return a.st.dueDate - b.st.dueDat    .due { color: #b00020; border-color: #ffd3da; background: #fff5f6; }
    .ok { color: #116b2f; border-color: #cfe9d8; background: #f3fbf6; }
    .actions { display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap; align-items: center; }

    .chk-wrap { display: flex; justify-content: center; padding-top: 6px; }
    input[type="checkbox"] { width: 22px; height: 22px; }

    /* Top due banner */
    .due-banner {
      background: #fff5f6;
      border: 1px solid #ffd3da;
      color: #b00020;
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 12px;
    }
    .due-banner .t { font-weight: 1000; }
    .due-banner ul { margin: 8px 0 0 18px; padding: 0; }
    .due-banner li { margin: 4px 0; }
    .small { font-size: 12px; opacity: .9; }

    /* Bottom fixed bar */
    .bottom-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(6px);
      border-top: 1px solid #e6e8ee;
      padding: 10px 12px;
      z-index: 4;
    }
    .bottom-inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .bottom-actions { display:flex; gap:8px; flex-wrap: wrap; justify-content:flex-end; }

    dialog { width: min(560px, 94vw); border: 1px solid #e6e8ee; border-radius: 14px; padding: 0; }
    dialog::backdrop { background: rgba(0,0,0,.35); }
    .modal-head { padding: 12px 14px; border-bottom: 1px solid #eef0f6; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 12px 14px; }
    .modal-foot { padding: 12px 14px; border-top: 1px solid #eef0f6; display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap; }
    .count { float: right; font-size: 12px; color: #666; }
    .tabs { display: flex; gap: 8px; margin-top: 10px; }
    .tabs button { flex: 1; }
    .hidden { display: none; }
    .hist-item { padding: 10px; border: 1px solid #eef0f6; border-radius: 12px; background: #fff; }
    .hist-item .t { font-weight: 900; }
    .hist-item .s { font-size: 12px; color: #555; margin-top: 2px; }

    input[type="text"], input[type="number"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid #d7dbe6; border-radius: 10px; font-size: 14px; }
    label { font-size: 12px; color: #333; font-weight: 900; display: block; margin: 10px 0 6px; }
  </style>
</head>
<body>
<header>
  <h1>Entretien</h1>
  <div class="toolbar">
    <button class="primary" id="btnAdd">+ Ajouter</button>
    <button id="btnHistory">Journal</button>
    <span class="pill" id="stats">‚Äî</span>
  </div>
</header>

<main>
  <div id="dueBanner" class="due-banner hidden" role="alert"></div>
  <div class="list" id="list"></div>
</main>

<!-- Bottom fixed bar -->
<div class="bottom-bar">
  <div class="bottom-inner">
    <div class="pill" id="pendingInfo">0 s√©lectionn√©(s) √† enregistrer</div>
    <div class="bottom-actions">
      <button id="btnExport">Export JSON</button>
      <button id="btnImport">Import JSON</button>
      <button id="btnClearChecks">R√©initialiser checks</button>
      <button class="primary" id="btnSaveChecks" disabled>Enregistrer</button>
    </div>
  </div>
  <input id="fileInput" type="file" accept="application/json,.json" class="hidden" />
</div>

<!-- Modal Ajout/Modification -->
<dialog id="dlgEdit">
  <div class="modal-head">
    <strong id="dlgTitle">Ajouter</strong>
    <button id="btnCloseEdit" aria-label="Fermer">‚úï</button>
  </div>
  <div class="modal-body">
    <label>
      Description <span class="count" id="descCount">0/50</span>
      <input id="fDesc" maxlength="50" placeholder="Ex: Changer filtre fournaise" />
    </label>

    <label>Date de d√©but
      <input id="fStart" type="date" />
    </label>

    <label>Intervalle (jours)
      <input id="fInt" type="number" min="1" step="1" placeholder="Ex: 90" />
    </label>
  </div>
  <div class="modal-foot">
    <button id="btnDelete" class="danger hidden">Supprimer</button>
    <button id="btnCancel">Annuler</button>
    <button id="btnSave" class="primary">Enregistrer l‚Äôitem</button>
  </div>
</dialog>

<!-- Modal Journal -->
<dialog id="dlgHistory">
  <div class="modal-head">
    <strong>Journal (Historique)</strong>
    <button id="btnCloseHist" aria-label="Fermer">‚úï</button>
  </div>
  <div class="modal-body">
    <div class="tabs">
      <button id="tabGlobal" class="primary">Regroup√© global</button>
      <button id="tabByItem">Par item</button>
    </div>

    <div id="viewGlobal" style="margin-top:12px; display:grid; gap:10px;"></div>

    <div id="viewByItem" class="hidden" style="margin-top:12px;">
      <select id="histItemSelect"></select>
      <div id="histItemEvents" style="margin-top:10px; display:grid; gap:10px;"></div>
    </div>

    <div class="small" style="margin-top:12px;">
      Astuce : Export/Import JSON te permet de sauvegarder ou restaurer tes donn√©es.
    </div>
  </div>
  <div class="modal-foot">
    <button id="btnClearHist" class="danger">Vider le journal</button>
    <button id="btnCloseHist2" class="primary">OK</button>
  </div>
</dialog>

<script>
(() => {
  // ===== Utils =====
  const pad2 = n => String(n).padStart(2, "0");
  const toYMD = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fromYMD = (s) => { const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d, 0,0,0,0); };
  const startOfToday = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
  const daysBetween = (a, b) => Math.floor((b.getTime() - a.getTime()) / 86400000);
  const addDays = (d, n) => new Date(d.getTime() + n * 86400000);
  const fmtDT = (ts) => new Date(ts).toLocaleString("fr-CA", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
  const escapeHtml = (s) => s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));

  // ===== IndexedDB =====
  const DB_NAME = "EntretienDB";
  const DB_VER  = 1;
  let db;

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;

        const items = db.createObjectStore("items", { keyPath: "id" });
        items.createIndex("by_desc", "description", { unique: false });

        const checks = db.createObjectStore("checks", { keyPath: "id" });
        checks.createIndex("by_item", "itemId", { unique: false });
        checks.createIndex("by_ts", "dateCheck", { unique: false });

        const alerts = db.createObjectStore("alerts", { keyPath: "id" });
        alerts.createIndex("by_item", "itemId", { unique: false });
        alerts.createIndex("by_dueKey", "dueKey", { unique: false });
        alerts.createIndex("by_ts", "dateAlert", { unique: false });

        const meta = db.createObjectStore("meta", { keyPath: "key" });
        meta.put({ key: "seed", value: 1 });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  function tx(storeNames, mode="readonly") {
    const t = db.transaction(storeNames, mode);
    return { t, stores: Object.fromEntries(storeNames.map(n => [n, t.objectStore(n)])) };
  }

  async function nextId() {
    const { t, stores } = tx(["meta"], "readwrite");
    return await new Promise((resolve, reject) => {
      const get = stores.meta.get("seed");
      get.onsuccess = () => {
        const seed = get.result?.value ?? 1;
        stores.meta.put({ key: "seed", value: seed + 1 });
        t.oncomplete = () => resolve(seed);
      };
      get.onerror = () => reject(get.error);
    });
  }

  function getAll(storeName, indexName=null, query=null) {
    return new Promise((resolve, reject) => {
      const { stores } = tx([storeName], "readonly");
      const source = indexName ? stores[storeName].index(indexName) : stores[storeName];
      const req = query ? source.getAll(query) : source.getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }

  function put(storeName, value) {
    return new Promise((resolve, reject) => {
      const { t, stores } = tx([storeName], "readwrite");
      stores[storeName].put(value);
      t.oncomplete = () => resolve();
      t.onerror = () => reject(t.error);
    });
  }

  async function deleteItemCascade(itemId) {
    const checks = await getAll("checks", "by_item", itemId);
    const alerts = await getAll("alerts", "by_item", itemId);

    const { t, stores } = tx(["items","checks","alerts"], "readwrite");
    stores.items.delete(itemId);
    checks.forEach(c => stores.checks.delete(c.id));
    alerts.forEach(a => stores.alerts.delete(a.id));

    return await new Promise((resolve, reject) => {
      t.oncomplete = () => resolve();
      t.onerror = () => reject(t.error);
    });
  }

  async function clearAllData() {
    const { t, stores } = tx(["items","checks","alerts"], "readwrite");
    stores.items.clear();
    stores.checks.clear();
    stores.alerts.clear();
    return await new Promise((resolve, reject) => {
      t.oncomplete = resolve;
      t.onerror = () => reject(t.error);
    });
  }

  // ===== Business logic =====
  async function lastCheckTs(itemId) {
    const list = await getAll("checks", "by_item", itemId);
    if (!list.length) return null;
    list.sort((a,b)=>b.dateCheck - a.dateCheck);
    return list[0].dateCheck;
  }

  async function computeStatus(item) {
    const today = startOfToday();
    const last = await lastCheckTs(item.id);
    const ref = last ? new Date(last) : fromYMD(item.dateDebut);
    ref.setHours(0,0,0,0);

    const dueDate = addDays(ref, Number(item.intervalJours));
    dueDate.setHours(0,0,0,0);

    const daysDue = Math.max(0, daysBetween(dueDate, today));
    const isDue = today.getTime() >= dueDate.getTime();
    return { lastTs: last, dueDate, isDue, daysDue };
  }

  async function ensureAlertLogged(item, status) {
    if (!status.isDue) return;
    const dueYMD = toYMD(status.dueDate);
    const dueKey = `${item.id}|${dueYMD}`;
    const all = await getAll("alerts");
    if (all.some(a => a.dueKey === dueKey)) return;

    const id = await nextId();
    await put("alerts", { id, itemId: item.id, dueKey, dueDateYMD: dueYMD, dateAlert: Date.now() });
  }

  // ===== UI refs =====
  const elList = document.querySelector("#list");
  const elStats = document.querySelector("#stats");
  const dueBanner = document.querySelector("#dueBanner");

  const pendingInfo = document.querySelector("#pendingInfo");
  const btnSaveChecks = document.querySelector("#btnSaveChecks");
  const btnClearChecks = document.querySelector("#btnClearChecks");

  const btnExport = document.querySelector("#btnExport");
  const btnImport = document.querySelector("#btnImport");
  const fileInput = document.querySelector("#fileInput");

  // Edit modal
  const dlgEdit = document.querySelector("#dlgEdit");
  const dlgTitle = document.querySelector("#dlgTitle");
  const fDesc = document.querySelector("#fDesc");
  const fStart = document.querySelector("#fStart");
  const fInt = document.querySelector("#fInt");
  const descCount = document.querySelector("#descCount");
  const btnDelete = document.querySelector("#btnDelete");

  // History modal
  const dlgHistory = document.querySelector("#dlgHistory");
  const viewGlobal = document.querySelector("#viewGlobal");
  const viewByItem = document.querySelector("#viewByItem");
  const histItemSelect = document.querySelector("#histItemSelect");
  const histItemEvents = document.querySelector("#histItemEvents");
  const tabGlobal = document.querySelector("#tabGlobal");
  const tabByItem = document.querySelector("#tabByItem");

  let selectedRowIndex = -1;
  let currentRows = []; // [{item, st}]
  let editingId = null;

  // Batch selection (checkboxes)
  const pending = new Set();

  function setDescCount() { descCount.textContent = `${fDesc.value.length}/50`; }
  fDesc.addEventListener("input", setDescCount);

  function openEdit(item=null) {
    editingId = item ? item.id : null;
    dlgTitle.textContent = item ? "Modifier" : "Ajouter";
    fDesc.value = item ? item.description : "";
    fStart.value = item ? item.dateDebut : toYMD(startOfToday());
    fInt.value = item ? item.intervalJours : "30";
    setDescCount();
    btnDelete.classList.toggle("hidden", !item);
    dlgEdit.showModal();
    setTimeout(()=>fDesc.focus(), 50);
  }
  function closeEdit() { dlgEdit.close(); }

  async function saveEdit() {
    const description = fDesc.value.trim();
    if (!description) return alert("Description requise.");
    if (description.length > 50) return alert("Max 50 caract√®res.");
    const dateDebut = fStart.value;
    if (!dateDebut) return alert("Date de d√©but requise.");
    const intervalJours = Number(fInt.value);
    if (!Number.isFinite(intervalJours) || intervalJours < 1) return alert("Intervalle (jours) doit √™tre >= 1.");

    if (editingId == null) {
      const id = await nextId();
      await put("items", { id, description, dateDebut, intervalJours });
    } else {
      await put("items", { id: editingId, description, dateDebut, intervalJours });
    }
    closeEdit();
    await render();
  }

  async function doDelete() {
    if (editingId == null) return;
    const ok = confirm("Supprimer cet item (et son journal) ?");
    if (!ok) return;
    await deleteItemCascade(editingId);
    pending.delete(editingId);
    closeEdit();
    await render();
  }

  function selectRow(i) {
    selectedRowIndex = i;
    [...elList.querySelectorAll(".row")].forEach((r, idx) => r.classList.toggle("selected", idx === i));
  }

  function updatePendingInfo() {
    pendingInfo.textContent = `${pending.size} s√©lectionn√©(s) √† enregistrer`;
    btnSaveChecks.disabled = pending.size === 0;
  }

  function buildConfirmationList() {
    const selected = currentRows.filter(r => pending.has(r.item.id)).map(r => r.item.description);
    selected.sort((a,b)=>a.localeCompare(b,"fr"));
    const preview = selected.slice(0, 10);
    const more = selected.length - preview.length;
    const lines = preview.map(s => `‚Ä¢ ${s}`);
    if (more > 0) lines.push(`‚Ä¢ ‚Ä¶ et ${more} autre(s)`);
    return { count: selected.length, text: lines.join("\n") };
  }

  async function savePendingChecks() {
    if (pending.size === 0) return;

    const { count, text } = buildConfirmationList();
    const ok = confirm(
      `Enregistrer "Fait" pour ${count} item(s) ?\n\n${text}\n\n` +
      `√áa r√©initialise leur prochaine date selon l‚Äôintervalle.`
    );
    if (!ok) return;

    const now = Date.now();
    for (const itemId of pending) {
      const id = await nextId();
      await put("checks", { id, itemId, dateCheck: now });
    }

    pending.clear();
    updatePendingInfo();
    await render();
  }

  function clearPendingChecksUIOnly() {
    pending.clear();
    updatePendingInfo();
    render();
  }

  function renderDueBanner(dueRows) {
    if (!dueRows.length) {
      dueBanner.classList.add("hidden");
      dueBanner.innerHTML = "";
      return;
    }

    // sort by dueDate (oldest due first)
    dueRows.sort((a,b)=>a.st.dueDate - b.st.dueDate);

    const itemsHtml = dueRows.slice(0, 20).map(r => {
      const dueYMD = toYMD(r.st.dueDate);
      return `<li><strong>${escapeHtml(r.item.description)}</strong> ‚Äî d√ª le <strong>${dueYMD}</strong> (retard: ${r.st.daysDue} j)</li>`;
    }).join("");

    const more = dueRows.length - Math.min(20, dueRows.length);
    const moreHtml = more > 0 ? `<div class="small" style="margin-top:8px;">‚Ä¶ et ${more} autre(s) √©l√©ment(s) d√ª(s).</div>` : "";

    dueBanner.innerHTML = `
      <div class="t">‚ö†Ô∏è Entretien(s) d√ª(s) (${dueRows.length})</div>
      <ul>${itemsHtml}</ul>
      ${moreHtml}
    `;
    dueBanner.classList.remove("hidden");
  }

  async function render() {
    const items = await getAll("items");

    const computed = [];
    for (const it of items) {
      const st = await computeStatus(it);
      await ensureAlertLogged(it, st);
      computed.push({ item: it, st });
    }

    // Default display: DU first, then nearest dueDate
    computed.sort((a,b) => {
      if (a.st.isDue !== b.st.isDue) return a.st.isDue ? -1 : 1;
      return a.st.dueDate - b.st.dueDate;
    });

    currentRows = computed;

    const dueRows = computed.filter(r => r.st.isDue);
    renderDueBanner(dueRows);

    elStats.textContent = `${computed.length} item(s) ‚Ä¢ ${dueRows.length} DU`;

    elList.innerHTML = "";
    computed.forEach(({item, st}, idx) => {
      const nextYMD = toYMD(st.dueDate);
      const badge = st.isDue ? `<span class="status due">DU (${st.daysDue} j)</span>` : `<span class="status ok">OK</span>`;

      const row = document.createElement("div");
      row.className = "row";
      row.tabIndex = 0;

      row.innerHTML = `
        <div class="chk-wrap">
          <input type="checkbox" aria-label="Check fait" ${pending.has(item.id) ? "checked" : ""}/>
        </div>
        <div>
          <div class="desc">${escapeHtml(item.description)}</div>
          <div class="meta">
            <div class="cols">Date d√©but: <strong>${item.dateDebut}</strong></div>
            <div class="cols">Intervalle: <strong>${item.intervalJours}</strong> jour(s)</div>
            <div class="cols">Prochaine date: <strong>${nextYMD}</strong></div>
          </div>
        </div>
        <div class="actions">
          ${badge}
          <button title="Modifier">‚úèÔ∏è</button>
          <button class="danger" title="Supprimer">üóëÔ∏è</button>
        </div>
      `;

      row.addEventListener("click", (e) => {
        if (e.target && e.target.tagName === "INPUT") return;
        selectRow(idx);
      });

      const chk = row.querySelector('input[type="checkbox"]');
      chk.addEventListener("change", () => {
        if (chk.checked) pending.add(item.id);
        else pending.delete(item.id);
        updatePendingInfo();
      });

      const btnEdit = row.querySelectorAll(".actions button")[0];
      const btnDel  = row.querySelectorAll(".actions button")[1];

      btnEdit.addEventListener("click", (e) => { e.stopPropagation(); openEdit(item); });
      btnDel.addEventListener("click", async (e) => {
        e.stopPropagation();
        const ok = confirm(`Supprimer (et journal) :\n\n${item.description} ?`);
        if (!ok) return;
        await deleteItemCascade(item.id);
        pending.delete(item.id);
        updatePendingInfo();
        await render();
      });

      elList.appendChild(row);
    });

    if (computed.length === 0) selectedRowIndex = -1;
    else if (selectedRowIndex >= computed.length) selectedRowIndex = computed.length - 1;
    if (selectedRowIndex >= 0) selectRow(selectedRowIndex);

    updatePendingInfo();
  }

  // Keyboard navigation
  document.addEventListener("keydown", (e) => {
    if (dlgEdit.open || dlgHistory.open) return;
    const rows = [...elList.querySelectorAll(".row")];
    if (!rows.length) return;

    if (e.key === "ArrowDown") {
      e.preventDefault();
      const i = Math.min(rows.length - 1, Math.max(0, selectedRowIndex + 1));
      selectRow(i); rows[i].scrollIntoView({ block: "nearest" });
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      const i = Math.max(0, selectedRowIndex - 1);
      selectRow(i); rows[i].scrollIntoView({ block: "nearest" });
    } else if (e.key === "Enter") {
      e.preventDefault();
      const cur = currentRows[selectedRowIndex];
      if (cur) openEdit(cur.item);
    } else if (e.key === " ") {
      e.preventDefault();
      const row = rows[selectedRowIndex];
      if (!row) return;
      const chk = row.querySelector('input[type="checkbox"]');
      chk.checked = !chk.checked;
      chk.dispatchEvent(new Event("change"));
    }
  });

  // Buttons
  document.querySelector("#btnAdd").addEventListener("click", () => openEdit(null));
  document.querySelector("#btnCloseEdit").addEventListener("click", closeEdit);
  document.querySelector("#btnCancel").addEventListener("click", closeEdit);
  document.querySelector("#btnSave").addEventListener("click", saveEdit);
  document.querySelector("#btnDelete").addEventListener("click", doDelete);

  btnSaveChecks.addEventListener("click", savePendingChecks);
  btnClearChecks.addEventListener("click", clearPendingChecksUIOnly);

  // ===== Export / Import JSON =====
  btnExport.addEventListener("click", exportJSON);
  btnImport.addEventListener("click", () => fileInput.click());
  fileInput.addEventListener("change", onImportFileChosen);

  async function exportJSON() {
    const items = await getAll("items");
    const checks = await getAll("checks");
    const alerts = await getAll("alerts");

    const payload = {
      app: "Entretien",
      schemaVersion: 1,
      exportedAt: new Date().toISOString(),
      data: { items, checks, alerts }
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `entretien-backup-${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function onImportFileChosen() {
    const file = fileInput.files?.[0];
    fileInput.value = "";
    if (!file) return;

    const text = await file.text();
    let json;
    try { json = JSON.parse(text); }
    catch { alert("Fichier JSON invalide."); return; }

    if (!json || json.app !== "Entretien" || !json.data) {
      alert("Ce JSON ne semble pas √™tre un backup Entretien.");
      return;
    }

    const items = json.data.items || [];
    const checks = json.data.checks || [];
    const alerts = json.data.alerts || [];

    const ok = confirm(
      `Importer backup ?\n\nItems: ${items.length}\nChecks: ${checks.length}\nAlertes: ${alerts.length}\n\n` +
      `‚ö†Ô∏è OK = REMPLACER toutes les donn√©es actuelles.`
    );
    if (!ok) return;

    await clearAllData();
    for (const it of items) await put("items", it);
    for (const c of checks) await put("checks", c);
    for (const a of alerts) await put("alerts", a);

    const maxId = Math.max(0, ...items.map(x => x.id||0), ...checks.map(x => x.id||0), ...alerts.map(x => x.id||0));
    const { t, stores } = tx(["meta"], "readwrite");
    stores.meta.put({ key: "seed", value: maxId + 1 });
    await new Promise((resolve, reject) => { t.oncomplete = resolve; t.onerror = () => reject(t.error); });

    pending.clear();
    updatePendingInfo();
    await render();
    alert("Import termin√© ‚úÖ");
  }

  // ===== Journal (History) =====
  document.querySelector("#btnHistory").addEventListener("click", openHistory);
  document.querySelector("#btnCloseHist").addEventListener("click", () => dlgHistory.close());
  document.querySelector("#btnCloseHist2").addEventListener("click", () => dlgHistory.close());

  tabGlobal.addEventListener("click", () => setHistTab("global"));
  tabByItem.addEventListener("click", () => setHistTab("item"));

  function setHistTab(which) {
    const isGlobal = which === "global";
    viewGlobal.classList.toggle("hidden", !isGlobal);
    viewByItem.classList.toggle("hidden", isGlobal);
    tabGlobal.classList.toggle("primary", isGlobal);
    tabByItem.classList.toggle("primary", !isGlobal);
  }

  async function openHistory() {
    await renderHistoryGlobal();
    await renderHistoryItemPicker();
    setHistTab("global");
    dlgHistory.showModal();
  }

  async function renderHistoryGlobal() {
    const items = await getAll("items");
    const byId = Object.fromEntries(items.map(i => [i.id, i.description]));

    const checks = await getAll("checks");
    const alerts = await getAll("alerts");

    const events = [];
    checks.forEach(c => events.push({ type:"done", ts:c.dateCheck, itemId:c.itemId }));

    alerts.forEach(a => {
      const dueDate = fromYMD(a.dueDateYMD);
      const alertDay = new Date(a.dateAlert); alertDay.setHours(0,0,0,0);
      const daysDue = Math.max(0, daysBetween(dueDate, alertDay));
      events.push({ type:"alert", ts:a.dateAlert, itemId:a.itemId, extra:{ dueDateYMD:a.dueDateYMD, daysDue } });
    });

    events.sort((a,b)=>b.ts - a.ts);

    viewGlobal.innerHTML = events.length ? "" : `<div class="hist-item">Aucun journal.</div>`;
    for (const ev of events.slice(0, 300)) {
      const desc = byId[ev.itemId] ?? `#${ev.itemId}`;
      const box = document.createElement("div");
      box.className = "hist-item";
      if (ev.type === "done") {
        box.innerHTML = `<div class="t">‚úÖ Fait ‚Äî ${escapeHtml(desc)}</div><div class="s">${fmtDT(ev.ts)}</div>`;
      } else {
        box.innerHTML = `<div class="t">üö® Alerte ‚Äî ${escapeHtml(desc)} ‚Äî d√ª depuis ${ev.extra.daysDue} j</div>
                         <div class="s">${fmtDT(ev.ts)} ‚Ä¢ √âch√©ance: ${ev.extra.dueDateYMD}</div>`;
      }
      viewGlobal.appendChild(box);
    }
  }

  async function renderHistoryItemPicker() {
    const items = await getAll("items");
    histItemSelect.innerHTML = "";
    items.sort((a,b)=>a.description.localeCompare(b.description,"fr")).forEach(it => {
      const opt = document.createElement("option");
      opt.value = String(it.id);
      opt.textContent = it.description;
      histItemSelect.appendChild(opt);
    });
    histItemSelect.onchange = renderHistoryForSelectedItem;
    await renderHistoryForSelectedItem();
  }

  async function renderHistoryForSelectedItem() {
    const itemId = Number(histItemSelect.value);
    if (!itemId) { histItemEvents.innerHTML = ""; return; }

    const item = (await getAll("items")).find(x => x.id === itemId);
    const checks = await getAll("checks", "by_item", itemId);
    const alerts = await getAll("alerts", "by_item", itemId);

    const events = [];
    checks.forEach(c => events.push({ type:"done", ts:c.dateCheck }));
    alerts.forEach(a => {
      const dueDate = fromYMD(a.dueDateYMD);
      const alertDay = new Date(a.dateAlert); alertDay.setHours(0,0,0,0);
      const daysDue = Math.max(0, daysBetween(dueDate, alertDay));
      events.push({ type:"alert", ts:a.dateAlert, extra:{ dueDateYMD:a.dueDateYMD, daysDue } });
    });
    events.sort((a,b)=>b.ts - a.ts);

    histItemEvents.innerHTML = "";
    const title = document.createElement("div");
    title.className = "hist-item";
    title.innerHTML = `<div class="t">üìå ${escapeHtml(item?.description ?? "")}</div>`;
    histItemEvents.appendChild(title);

    if (!events.length) {
      const empty = document.createElement("div");
      empty.className = "hist-item";
      empty.textContent = "Aucun √©v√©nement pour cet item.";
      histItemEvents.appendChild(empty);
      return;
    }

    for (const ev of events.slice(0, 300)) {
      const box = document.createElement("div");
      box.className = "hist-item";
      if (ev.type === "done") {
        box.innerHTML = `<div class="t">‚úÖ Fait</div><div class="s">${fmtDT(ev.ts)}</div>`;
      } else {
        box.innerHTML = `<div class="t">üö® Alerte ‚Äî d√ª depuis ${ev.extra.daysDue} j</div>
                         <div class="s">${fmtDT(ev.ts)} ‚Ä¢ √âch√©ance: ${ev.extra.dueDateYMD}</div>`;
      }
      histItemEvents.appendChild(box);
    }
  }

  document.querySelector("#btnClearHist").addEventListener("click", async () => {
    const ok = confirm("Vider tout le journal (Fait + Alertes) ? Les items restent.");
    if (!ok) return;

    const { t, stores } = tx(["checks","alerts"], "readwrite");
    stores.checks.clear();
    stores.alerts.clear();
    await new Promise((resolve, reject) => { t.oncomplete = resolve; t.onerror = () => reject(t.error); });

    pending.clear();
    updatePendingInfo();
    await renderHistoryGlobal();
    await render();
  });

  // Auto refresh
  setInterval(render, 5 * 60 * 1000);

  // Init
  (async function init() {
    db = await openDB();
    updatePendingInfo();
    await render();
  })();

})();
</script>
</body>
</html>

